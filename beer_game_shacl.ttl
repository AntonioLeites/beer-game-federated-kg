@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix bg: <http://beergame.org/ontology#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

# ============================================================
# ACTOR METRICS SHAPE - Core temporal metrics validation
# ============================================================

bg:ActorMetricsShape a sh:NodeShape ;
    sh:targetClass bg:ActorMetrics ;
    
    # Must belong to exactly one Actor
    sh:property [
        sh:path bg:belongsTo ;
        sh:class bg:Actor ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "ActorMetrics must belong to exactly one Actor." ;
    ] ;
    
    # Must be associated with exactly one Week
    sh:property [
        sh:path bg:forWeek ;
        sh:class bg:Week ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "ActorMetrics must be associated with exactly one Week." ;
    ] ;
    
    # Inventory coverage validation
    sh:property [
        sh:path bg:inventoryCoverage ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "inventoryCoverage must be a non-negative decimal." ;
    ] ;
    
    # Suggested order quantity validation
    sh:property [
        sh:path bg:suggestedOrderQuantity ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "suggestedOrderQuantity must be a non-negative decimal." ;
    ] ;
    
    # Demand rate validation
    sh:property [
        sh:path bg:demandRate ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "demandRate must be a non-negative decimal." ;
    ] ;
    
    # Bullwhip risk flag validation
    sh:property [
        sh:path bg:hasBullwhipRisk ;
        sh:datatype xsd:boolean ;
        sh:maxCount 1 ;
        sh:message "hasBullwhipRisk must be a boolean value." ;
    ] ;
    
    # Stockout risk flag validation
    sh:property [
        sh:path bg:hasStockoutRisk ;
        sh:datatype xsd:boolean ;
        sh:maxCount 1 ;
        sh:message "hasStockoutRisk must be a boolean value." ;
    ] .

# ============================================================
# UNIQUENESS: One ActorMetrics per Actor and Week
# ============================================================

bg:UniqueMetricsPerWeekShape a sh:NodeShape ;
    sh:targetClass bg:ActorMetrics ;
    sh:sparql [
        sh:message "Only one ActorMetrics per Actor and Week is allowed." ;
        sh:select """
            PREFIX bg: <http://beergame.org/ontology#>
            SELECT $this
            WHERE {
                $this bg:belongsTo ?actor ;
                      bg:forWeek ?week .
                ?other bg:belongsTo ?actor ;
                       bg:forWeek ?week .
                FILTER (?other != $this)
            }
        """ ;
    ] .

# ============================================================
# PROHIBITION: No direct metrics on Actor
# ============================================================

bg:NoDirectMetricsOnActorShape a sh:NodeShape ;
    sh:targetClass bg:Actor ;
    sh:sparql [
        sh:message "Metrics must not be attached directly to Actor; use ActorMetrics." ;
        sh:select """
            PREFIX bg: <http://beergame.org/ontology#>
            SELECT $this
            WHERE {
                $this ?p ?v .
                FILTER (?p IN (
                    bg:inventoryCoverage,
                    bg:suggestedOrderQuantity,
                    bg:hasBullwhipRisk,
                    bg:hasStockoutRisk,
                    bg:demandRate
                ))
            }
        """ ;
    ] .

# ============================================================
# INVENTORY SHAPE - Temporal inventory validation
# ============================================================

bg:InventoryShape a sh:NodeShape ;
    sh:targetClass bg:Inventory ;
    
    # Must belong to exactly one Actor
    sh:property [
        sh:path bg:belongsTo ;
        sh:class bg:Actor ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Inventory must belong to exactly one Actor." ;
    ] ;
    
    # Must be associated with exactly one Week
    sh:property [
        sh:path bg:forWeek ;
        sh:class bg:Week ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Inventory must be associated with exactly one Week." ;
    ] ;
    
    # Current inventory validation
    sh:property [
        sh:path bg:currentInventory ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "currentInventory must be a non-negative decimal." ;
    ] ;
    
    # Backlog validation
    sh:property [
        sh:path bg:backlog ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "backlog must be a non-negative decimal." ;
    ] ;
    
    # Holding cost validation
    sh:property [
        sh:path bg:holdingCost ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "holdingCost must be a non-negative decimal." ;
    ] ;
    
    # Backlog cost validation
    sh:property [
        sh:path bg:backlogCost ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "backlogCost must be a non-negative decimal." ;
    ] .

# ============================================================
# ORDER SHAPE - Order flow validation
# ============================================================

bg:OrderShape a sh:NodeShape ;
    sh:targetClass bg:Order ;
    
    # Must be placed by exactly one Actor
    sh:property [
        sh:path bg:placedBy ;
        sh:class bg:Actor ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Order must be placed by exactly one Actor." ;
    ] ;
    
    # Must be received by exactly one Actor (upstream supplier)
    sh:property [
        sh:path bg:receivedBy ;
        sh:class bg:Actor ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Order must be received by exactly one Actor (upstream supplier)." ;
    ] ;
    
    # Must be associated with exactly one Week
    sh:property [
        sh:path bg:forWeek ;
        sh:class bg:Week ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Order must be associated with exactly one Week." ;
    ] ;
    
    # Order quantity validation - INTEGER for discrete units
    sh:property [
        sh:path bg:orderQuantity ;
        sh:datatype xsd:integer ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "orderQuantity must be a non-negative integer (discrete units)." ;
    ] .

# ============================================================
# SHIPMENT SHAPE - Shipment flow validation
# ============================================================

bg:ShipmentShape a sh:NodeShape ;
    sh:targetClass bg:Shipment ;
    
    # Must be shipped from exactly one Actor
    sh:property [
        sh:path bg:shippedFrom ;
        sh:class bg:Actor ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Shipment must be shipped from exactly one Actor." ;
    ] ;
    
    # Must be shipped to exactly one Actor (downstream customer)
    sh:property [
        sh:path bg:shippedTo ;
        sh:class bg:Actor ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Shipment must be shipped to exactly one Actor (downstream customer)." ;
    ] ;
    
    # Must be associated with exactly one Week (creation week)
    sh:property [
        sh:path bg:forWeek ;
        sh:class bg:Week ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Shipment must be associated with exactly one Week." ;
    ] ;
    
    # Quantity validation - INTEGER for discrete units
    sh:property [
        sh:path bg:quantity ;
        sh:datatype xsd:integer ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "Shipment quantity must be a non-negative integer (discrete units)." ;
    ] ;
    
    # Arrival week validation - LINKED to bg:Week for consistency
    sh:property [
        sh:path bg:arrivalWeek ;
        sh:class bg:Week ;
        sh:nodeKind sh:IRI ;
        sh:maxCount 1 ;
        sh:message "arrivalWeek must reference a valid bg:Week instance." ;
    ] .

# ============================================================
# WEEK SHAPE - Temporal consistency validation
# ============================================================

bg:WeekShape a sh:NodeShape ;
    sh:targetClass bg:Week ;
    
    # Week number validation
    sh:property [
        sh:path bg:weekNumber ;
        sh:datatype xsd:integer ;
        sh:minInclusive 1 ;
        sh:maxCount 1 ;
        sh:message "weekNumber must be a positive integer." ;
    ] ;
    
    # Prevent self-reference
    sh:sparql [
        sh:message "A Week must not reference itself as previousWeek." ;
        sh:select """
            PREFIX bg: <http://beergame.org/ontology#>
            SELECT $this
            WHERE {
                $this bg:previousWeek $this .
            }
        """ ;
    ] ;
    
    # Prevent multiple previous weeks
    sh:sparql [
        sh:message "A Week must have at most one previousWeek." ;
        sh:select """
            PREFIX bg: <http://beergame.org/ontology#>
            SELECT $this
            WHERE {
                $this bg:previousWeek ?w1, ?w2 .
                FILTER (?w1 != ?w2)
            }
        """ ;
    ] .

# ============================================================
# CUSTOMER DEMAND SHAPE - Demand validation
# ============================================================

bg:CustomerDemandShape a sh:NodeShape ;
    sh:targetClass bg:CustomerDemand ;
    
    # Must be associated with exactly one Week
    sh:property [
        sh:path bg:forWeek ;
        sh:class bg:Week ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "CustomerDemand must be associated with exactly one Week." ;
    ] ;
    
    # Actual demand validation
    sh:property [
        sh:path bg:actualDemand ;
        sh:datatype xsd:integer ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "actualDemand must be a non-negative integer." ;
    ] .

# ============================================================
# ACTOR SHAPE - Basic actor validation
# ============================================================

bg:ActorShape a sh:NodeShape ;
    sh:targetClass bg:Actor ;
    
    # Shipping delay validation
    sh:property [
        sh:path bg:shippingDelay ;
        sh:datatype xsd:integer ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "shippingDelay must be a non-negative integer." ;
    ] ;
    
    # Order delay validation
    sh:property [
        sh:path bg:orderDelay ;
        sh:datatype xsd:integer ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "orderDelay must be a non-negative integer." ;
    ] ;
    
    # Budget constraint validation
    sh:property [
        sh:path bg:budgetConstraint ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxCount 1 ;
        sh:message "budgetConstraint must be a non-negative decimal." ;
    ] .
# ============================================================
# DECISION CONTEXT SHAPE - Context traceability validation
# ============================================================

bg:DecisionContextShape a sh:NodeShape ;
    sh:targetClass bg:DecisionContext ;
    
    # Must belong to exactly one Actor
    sh:property [
        sh:path bg:belongsTo ;
        sh:class bg:Actor ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "DecisionContext must belong to exactly one Actor." ;
    ] ;
    
    # Must be associated with exactly one Week
    sh:property [
        sh:path bg:forWeek ;
        sh:class bg:Week ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "DecisionContext must be associated with exactly one Week." ;
    ] ;
    
    # Must capture inventory state
    sh:property [
        sh:path bg:capturesInventoryState ;
        sh:class bg:Inventory ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "DecisionContext must capture exactly one Inventory state." ;
    ] ;
    
    # Must capture metrics
    sh:property [
        sh:path bg:capturesMetrics ;
        sh:class bg:ActorMetrics ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "DecisionContext must capture exactly one ActorMetrics snapshot." ;
    ] ;
    
    # Decision rationale validation
    sh:property [
        sh:path bg:decisionRationale ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:message "decisionRationale must be a string." ;
    ] ;
    
    # Active policy validation
    sh:property [
        sh:path bg:activePolicy ;
        sh:datatype xsd:string ;
        sh:in ( "conservative" "aggressive" "reactive" "predictive" "balanced" ) ;
        sh:maxCount 1 ;
        sh:message "activePolicy must be one of: conservative, aggressive, reactive, predictive, balanced." ;
    ] ;
    
    # Perceived trend validation
    sh:property [
        sh:path bg:perceivedTrend ;
        sh:datatype xsd:string ;
        sh:in ( "increasing" "stable" "decreasing" "volatile" "unknown" ) ;
        sh:maxCount 1 ;
        sh:message "perceivedTrend must be one of: increasing, stable, decreasing, volatile, unknown." ;
    ] ;
    
    # Risk assessment validation
    sh:property [
        sh:path bg:riskAssessment ;
        sh:datatype xsd:string ;
        sh:in ( "low" "medium" "high" "critical" ) ;
        sh:maxCount 1 ;
        sh:message "riskAssessment must be one of: low, medium, high, critical." ;
    ] ;
    
    # Outcome quality validation
    sh:property [
        sh:path bg:outcomeQuality ;
        sh:datatype xsd:string ;
        sh:in ( "optimal" "good" "suboptimal" "poor" "unknown" ) ;
        sh:maxCount 1 ;
        sh:message "outcomeQuality must be one of: optimal, good, suboptimal, poor, unknown." ;
    ] ;
    
    # Boolean outcome flags
    sh:property [
        sh:path bg:causedBullwhip ;
        sh:datatype xsd:boolean ;
        sh:maxCount 1 ;
    ] ;
    
    sh:property [
        sh:path bg:causedStockout ;
        sh:datatype xsd:boolean ;
        sh:maxCount 1 ;
    ] .

# ============================================================
# ORDER-CONTEXT LINKING VALIDATION
# ============================================================

bg:OrderContextLinkShape a sh:NodeShape ;
    sh:targetClass bg:Order ;
    
    # Every order should ideally have a context (warning, not error)
    sh:property [
        sh:path bg:basedOnContext ;
        sh:class bg:DecisionContext ;
        sh:nodeKind sh:IRI ;
        sh:maxCount 1 ;
        sh:severity sh:Warning ;
        sh:message "Order should have a DecisionContext for full traceability." ;
    ] .

# ============================================================
# CONTEXT CONSISTENCY VALIDATION
# ============================================================

bg:ContextConsistencyShape a sh:NodeShape ;
    sh:targetClass bg:DecisionContext ;
    
    # Context week must match captured entities' week
    sh:sparql [
        sh:message "DecisionContext week must match its captured Inventory week." ;
        sh:select """
            PREFIX bg: <http://beergame.org/ontology#>
            SELECT $this
            WHERE {
                $this bg:forWeek ?contextWeek ;
                      bg:capturesInventoryState ?inv .
                ?inv bg:forWeek ?invWeek .
                FILTER (?contextWeek != ?invWeek)
            }
        """ ;
    ] ;
    
    sh:sparql [
        sh:message "DecisionContext week must match its captured Metrics week." ;
        sh:select """
            PREFIX bg: <http://beergame.org/ontology#>
            SELECT $this
            WHERE {
                $this bg:forWeek ?contextWeek ;
                      bg:capturesMetrics ?metrics .
                ?metrics bg:forWeek ?metricsWeek .
                FILTER (?contextWeek != ?metricsWeek)
            }
        """ ;
    ] ;
    
    # Context actor must match captured entities' actor
    sh:sparql [
        sh:message "DecisionContext actor must match its captured entities' actor." ;
        sh:select """
            PREFIX bg: <http://beergame.org/ontology#>
            SELECT $this
            WHERE {
                $this bg:belongsTo ?contextActor ;
                      bg:capturesInventoryState ?inv .
                ?inv bg:belongsTo ?invActor .
                FILTER (?contextActor != ?invActor)
            }
        """ ;
    ] .