# ============================================================
# BEER GAME - CONTEXT KNOWLEDGE GRAPH QUERIES
# Decision Traceability and Counterfactual Analysis
# ============================================================

PREFIX bg: <http://beergame.org/ontology#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# ============================================================
# NOTE ON EXECUTION:
# These queries are designed for the federated BG_Supply_Chain endpoint.
# Use DISTINCT to prevent federation duplicates.
# For single-actor analysis, queries can run on individual repositories
# (BG_Retailer, BG_Wholesaler, etc.) for better performance.
# ============================================================

# ============================================================
# QUERY 1: Full Decision Audit Trail for Specific Week
# ============================================================
# Purpose: Complete reconstruction of decision context
# Use case: "Why did Retailer order 20 units in Week 3?"

PREFIX bg_retailer: <http://beergame.org/retailer#>

SELECT DISTINCT ?decision ?quantity ?rationale ?policy ?trend ?risk
       ?inventory ?backlog ?demandRate ?coverage
WHERE {
    ?decision a bg:Order ;
              bg:placedBy bg_retailer:Retailer_Alpha ;
              bg:forWeek ?weekIRI ;
              bg:orderQuantity ?quantity ;
              bg:basedOnContext ?context .
    
    ?weekIRI bg:weekNumber 3 .
    
    ?context bg:decisionRationale ?rationale ;
             bg:activePolicy ?policy ;
             bg:perceivedTrend ?trend ;
             bg:riskAssessment ?risk ;
             bg:capturesInventoryState ?invState ;
             bg:capturesMetrics ?metrics .
    
    ?invState bg:currentInventory ?inventory ;
              bg:backlog ?backlog .
    
    ?metrics bg:demandRate ?demandRate ;
             bg:inventoryCoverage ?coverage .
}

# ============================================================
# QUERY 2: Bullwhip Analysis - Which Decisions Amplified Orders?
# ============================================================
# Purpose: Identify decisions that contributed to bullwhip effect
# Use case: Post-game analysis of amplification patterns

SELECT DISTINCT ?actor ?week ?orderQty ?demandRate ?amplification ?rationale
WHERE {
    ?context a bg:DecisionContext ;
             bg:belongsTo ?actor ;
             bg:forWeek ?weekIRI ;
             bg:causedBullwhip "true"^^xsd:boolean ;
             bg:capturesMetrics ?metrics ;
             bg:decisionRationale ?rationale .
    
    ?weekIRI bg:weekNumber ?week .
    
    ?metrics bg:demandRate ?demandRate .
    
    ?order a bg:Order ;
           bg:basedOnContext ?context ;
           bg:placedBy ?actor ;
           bg:forWeek ?weekIRI ;
           bg:orderQuantity ?orderQty .
    
    BIND(?orderQty / ?demandRate AS ?amplification)
    
    FILTER(?amplification > 1.5)
}
ORDER BY DESC(?amplification)

# ============================================================
# QUERY 3: All Decision Contexts Summary
# ============================================================
# Purpose: Overview of all decisions with outcomes
# Use case: Dashboard view of decision quality

SELECT DISTINCT ?actor ?week ?orderQty ?rationale ?policy ?quality ?outcome
WHERE {
    ?context a bg:DecisionContext ;
             bg:belongsTo ?actor ;
             bg:forWeek ?weekIRI ;
             bg:decisionRationale ?rationale ;
             bg:activePolicy ?policy .
    
    ?weekIRI bg:weekNumber ?week .
    
    ?order a bg:Order ;
           bg:basedOnContext ?context ;
           bg:orderQuantity ?orderQty .
    
    OPTIONAL { ?context bg:outcomeQuality ?quality }
    OPTIONAL { ?context bg:actualOutcome ?outcome }
}
ORDER BY ?week ?actor

# ============================================================
# QUERY 4: High-Risk Decisions Analysis
# ============================================================
# Purpose: Which high-risk decisions could have caused problems?
# Use case: "What decisions were risky but got lucky?"
# Note: Only shows results when high/critical risk decisions exist

SELECT DISTINCT ?actor ?week ?orderQty ?coverage ?risk ?quality ?outcome
WHERE {
    ?context a bg:DecisionContext ;
             bg:belongsTo ?actor ;
             bg:forWeek ?weekIRI ;
             bg:riskAssessment ?risk ;
             bg:capturesMetrics ?metrics .
    
    ?weekIRI bg:weekNumber ?week .
    
    ?metrics bg:inventoryCoverage ?coverage .
    
    ?order bg:basedOnContext ?context ;
           bg:orderQuantity ?orderQty .
    
    OPTIONAL { ?context bg:outcomeQuality ?quality }
    OPTIONAL { ?context bg:actualOutcome ?outcome }
    
    FILTER(?risk = "critical" || ?risk = "high")
}
ORDER BY ?coverage

# ============================================================
# QUERY 5: Policy Effectiveness Analysis
# ============================================================
# Purpose: Which ordering policies led to best outcomes?
# Use case: "Should we recommend conservative or aggressive?"

SELECT ?policy 
       (COUNT(DISTINCT ?context) AS ?totalDecisions)
       (SUM(IF(?quality="optimal", 1, 0)) AS ?optimalCount)
       (SUM(IF(?quality="good", 1, 0)) AS ?goodCount)
       (SUM(IF(?quality="suboptimal", 1, 0)) AS ?suboptimalCount)
       (SUM(IF(?quality="poor", 1, 0)) AS ?poorCount)
WHERE {
    ?context a bg:DecisionContext ;
             bg:activePolicy ?policy .
    
    OPTIONAL { ?context bg:outcomeQuality ?quality }
}
GROUP BY ?policy
ORDER BY DESC(?optimalCount)

# ============================================================
# QUERY 6: Trend Detection Accuracy
# ============================================================
# Purpose: Were perceived trends accurate?
# Use case: "Did 'increasing' trends actually increase?"

SELECT ?trend 
       (COUNT(DISTINCT ?context) AS ?decisions) 
       (AVG(?amplification) AS ?avgAmplification)
WHERE {
    ?context a bg:DecisionContext ;
             bg:perceivedTrend ?trend ;
             bg:capturesMetrics ?metrics .
    
    ?order bg:basedOnContext ?context ;
           bg:orderQuantity ?orderQty .
    
    ?metrics bg:demandRate ?demandRate .
    
    BIND(?orderQty / ?demandRate AS ?amplification)
}
GROUP BY ?trend
ORDER BY ?trend

# ============================================================
# QUERY 7: Risk Assessment Validation
# ============================================================
# Purpose: Were high-risk decisions actually problematic?
# Use case: "Did 'critical' risk lead to poor outcomes?"

SELECT ?risk 
       (COUNT(DISTINCT ?context) AS ?decisions)
       (SUM(IF(?causedBullwhip="true"^^xsd:boolean, 1, 0)) AS ?bullwhipCount)
       (SUM(IF(?causedStockout="true"^^xsd:boolean, 1, 0)) AS ?stockoutCount)
WHERE {
    ?context a bg:DecisionContext ;
             bg:riskAssessment ?risk .
    
    OPTIONAL { ?context bg:causedBullwhip ?causedBullwhip }
    OPTIONAL { ?context bg:causedStockout ?causedStockout }
}
GROUP BY ?risk
ORDER BY ?risk

# ============================================================
# QUERY 8: Complete Decision Timeline (Single Actor)
# ============================================================
# Purpose: Full decision history for one actor
# Use case: "Show me all Retailer decisions with outcomes"

PREFIX bg_retailer: <http://beergame.org/retailer#>

SELECT ?week ?orderQty ?rationale ?policy ?trend ?risk 
       ?quality ?outcome ?bullwhip ?stockout
WHERE {
    ?context a bg:DecisionContext ;
             bg:belongsTo bg_retailer:Retailer_Alpha ;
             bg:forWeek ?weekIRI ;
             bg:decisionRationale ?rationale ;
             bg:activePolicy ?policy ;
             bg:perceivedTrend ?trend ;
             bg:riskAssessment ?risk .
    
    ?weekIRI bg:weekNumber ?week .
    
    ?order bg:basedOnContext ?context ;
           bg:orderQuantity ?orderQty .
    
    OPTIONAL { ?context bg:outcomeQuality ?quality }
    OPTIONAL { ?context bg:actualOutcome ?outcome }
    OPTIONAL { ?context bg:causedBullwhip ?bullwhip }
    OPTIONAL { ?context bg:causedStockout ?stockout }
}
ORDER BY ?week

# ============================================================
# QUERY 9: Stockout Root Cause (when stockouts exist)
# ============================================================
# Purpose: Trace backwards from stockout to causative decision
# Use case: "What decision caused the stockout?"
# Note: Only returns results when backlog > 0 exists

SELECT DISTINCT ?stockoutActor ?stockoutWeek ?causativeWeek 
       ?orderQty ?rationale ?trend
WHERE {
    ?invState a bg:Inventory ;
              bg:belongsTo ?stockoutActor ;
              bg:forWeek ?stockoutWeekIRI ;
              bg:backlog ?backlog .
    
    ?stockoutWeekIRI bg:weekNumber ?stockoutWeek .
    FILTER(?backlog > 0)
    
    ?causativeOrder a bg:Order ;
                    bg:placedBy ?stockoutActor ;
                    bg:forWeek ?causativeWeekIRI ;
                    bg:orderQuantity ?orderQty ;
                    bg:basedOnContext ?context .
    
    ?causativeWeekIRI bg:weekNumber ?causativeWeek .
    
    ?context bg:causedStockout "true"^^xsd:boolean ;
             bg:decisionRationale ?rationale ;
             bg:perceivedTrend ?trend .
    
    FILTER(?causativeWeek < ?stockoutWeek)
}
ORDER BY ?stockoutWeek ?causativeWeek
